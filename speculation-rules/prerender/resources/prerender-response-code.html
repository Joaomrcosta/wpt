<head>
<script src="/common/utils.js"></script>
<script src="./utils.js"></script>
<script>
    const search = new URLSearchParams(location.search);
    const uid = search.get('uid');
    const bc = new BroadcastChannel(uid);
    const timeout = search.has('timeout') ? +search.get('timeout') : 0;

    window.onload = async () => {
        const content = '<' + `script>
        const bc = new BroadcastChannel('${uid}');
        bc.addEventListener('message', ({data}) => {
            if (data === 'close')
                window.close();
        })
        document.addEventListener('prerenderingchange', () => bc.postMessage('activated'));
        bc.postMessage(document.prerendering ? 'prerendering' : 'discarded');
        <` + '/script>';
        const url = `./echo-response-code.py?mode=echo&uid=${uid}&code=${search.get('code')}&content=${encodeURIComponent(content)}`;
        bc.addEventListener('message', ({data}) => {
            if (data === 'close')
                window.close();
            else if (data === 'activate') {
                location.href = url;
                if (timeout)
                    setTimeout(() => bc.postMessage('activated'), 500);
            }
        })

        startPrerendering(url);
        if (timeout)
            setTimeout(() => bc.postMessage('prerendering'), timeout);

    };
</script>
</head>